- name: Checks
  block:
    - name: Check Samba-Ad-Dc Service status
      command: samba-tool drs showrepl
      register: samba_tool_drs_showrepl
      failed_when: samba_tool_drs_showrepl.rc != 0 and "failed" not in samba_tool_drs_showrepl.stderr and "failed" not in samba_tool_drs_showrepl.stdout
      until: samba_tool_drs_showrepl.failed == false
      retries: 5
      delay: 1

    - name: Check DNS entries from the AD matches the resolver
      loop: "{{ ansible_play_batch | product(['ad001', 'ad002']) | list }}"
      environment:
        target_adc: "{{ item[0] }}"
        dns_entry_adc: "{{ item[1] }}.srv.zam.haus"
        dns_entry_resolver: "{{ item[1] }}.ad.arv.zam.haus"
      # Verify that the DNS entry from the AD matches the resolver in A and AAAA records
      script: "scripts/check_dns.sh"
      tags: [ fails ]

